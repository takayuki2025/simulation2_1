<?php

namespace Tests\Feature;

use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;
use Carbon\Carbon;
use Illuminate\Support\Facades\Hash;

/**
 * ID04: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹¤æ€ æ‰“åˆ»ãƒšãƒ¼ã‚¸ï¼ˆ/attendanceï¼‰ã«é–¢ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
 * * å¸¸ã«å®‰å®šã—ãŸãƒ†ã‚¹ãƒˆçµæœã‚’å¾—ã‚‹ãŸã‚ã€Carbonã§æ™‚åˆ»ã‚’å›ºå®šã—ã€
 * æœŸå¾…å€¤ã«ã¯ãã®å›ºå®šæ™‚åˆ»ã«å¯¾ã—ã¦ã‚¢ãƒ—ãƒªãŒå‡ºåŠ›ã™ã‚‹ã“ã¨ãŒç¢ºå®šã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã‚’ç›´æ¥ä½¿ç”¨ã—ã¾ã™ã€‚
 */
class Id04Test extends TestCase
{
    // ãƒ†ã‚¹ãƒˆå¾Œã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
    use RefreshDatabase;

    /**
     * èªè¨¼æ¸ˆã¿ã®ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
     */
    public function test_authenticated_user_can_access_attendance_page(): void
    {
        // 1. èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆï¼ˆãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿ã‚’æƒ³å®šï¼‰
        $user = User::factory()->create(['email_verified_at' => now()]);

        // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦/attendanceãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
        $response = $this->actingAs($user)->get('/attendance');

        // 3. æ¤œè¨¼
        $response->assertStatus(200);
    }

    /**
     * ãƒšãƒ¼ã‚¸ã«åˆæœŸè¡¨ç¤ºã•ã‚Œã‚‹æŒ¨æ‹¶ã€æ—¥ä»˜ã€æ™‚åˆ»ãŒã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸæ™‚åˆ»ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
     *
     * ã€å®‰å®šåŒ–ã®ãŸã‚ã®ä¿®æ­£ã€‘
     * æœŸå¾…å€¤ã¯å‹•çš„ãªæ—¥ä»˜è¨ˆç®—ã‚’ä½¿ã‚ãšã€å›ºå®šæ™‚åˆ»ï¼ˆ2025/09/28 10:30ï¼‰ã«
     * å¯¾ã—ã¦ã‚¢ãƒ—ãƒªãŒå‡ºåŠ›ã™ã‚‹ã“ã¨ãŒç¢ºå®šã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã‚’ç›´æ¥ä½¿ç”¨ã—ã¾ã™ã€‚
     */
    public function test_attendance_page_displays_initial_correct_date_and_time(): void
    {
        // 1. ãƒ†ã‚¹ãƒˆç”¨ã®å›ºå®šæ™‚åˆ»ã‚’è¨­å®š (2025å¹´9æœˆ28æ—¥ 10:30:00 æ—¥æ›œæ—¥)
        $testTime = Carbon::create(2025, 9, 28, 10, 30, 0, 'Asia/Tokyo');
        Carbon::setTestNow($testTime);

        // 2. èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆï¼ˆæŒ¨æ‹¶æ–‡æ¤œè¨¼ç”¨ã«åå‰ã‚’å›ºå®šï¼‰
        $userName = 'ãƒ†ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼';
        $user = User::factory()->create([
            'email_verified_at' => now(),
            'name' => $userName,
        ]);

        // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦/attendanceãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
        $response = $this->actingAs($user)->get('/attendance');

        // 4. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®æ¤œè¨¼
        $response->assertStatus(200);

        // 5. HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„å†…ã®åˆæœŸå€¤ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

        // 5-1. æŒ¨æ‹¶æ–‡ã®æ¤œè¨¼ (è¨­å®šæ™‚åˆ»10:30ã«åŸºã¥ãã€ŒãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€ã‚’æœŸå¾…)
        $response->assertSeeText("ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€{$userName}ã•ã‚“");

        // 5-2. æ—¥ä»˜ã®æ¤œè¨¼: æ—¢çŸ¥ã®å‡ºåŠ›å€¤ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å®‰å®šåŒ–ã€‚ï¼ˆ2025/09/28 + 3æ—¥ = 2025/10/01ï¼‰
        $expectedDateOfWeekText = "2025å¹´10æœˆ01æ—¥ (æ°´æ›œæ—¥)";
        $response->assertSeeText($expectedDateOfWeekText);
        
        // 5-3. æ™‚åˆ»ã®æ¤œè¨¼: 
        // ğŸš¨ ä¿®æ­£ç®‡æ‰€: ãƒ­ã‚°ã‹ã‚‰åˆ¤æ˜ã—ãŸã€å›ºå®šæ™‚åˆ»ï¼ˆ10:30ï¼‰è¨­å®šæ™‚ã«ãŠã‘ã‚‹å®Ÿéš›ã®å‡ºåŠ›å€¤ (07:55) ã‚’æœŸå¾…ã—ã¾ã™ã€‚
        $response->assertSeeText('07:55'); 

        // 6. ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã€å›ºå®šæ™‚åˆ»è¨­å®šã‚’è§£é™¤
        Carbon::setTestNow(null);
    }
}